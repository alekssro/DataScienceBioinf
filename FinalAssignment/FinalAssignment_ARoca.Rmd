---
title: "Final Assignment"
author: "Alejandro Roca"
date: "2017 M11 30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Whole-genome patterns of nucleotide diversity & recombination in the model legume Medicago truncatula

<!-- Notes for project:  -->

<!-- filter (maybe filter windows with small size) -->

<!-- finding CI for median: bootstrap approach (slice data by chromosome and resample them, calculate the median and get the distribution) - example in book (chimpanzee example) -->

<!-- 4- how much gen diversity vary among windows: qp.site ~ recomb (nt div per site, are the SNP far away or not?) whar are the variables to explain window diversity (qp.site) -> chr, recomb, genedensity   -->
<!-- *background selection: deleterious mutations are eliminated from population and that takes other SNPs with it (LD), we would expect less density in the window. Look how are compared models taking into account the gene density and models taking into account also chr, recombination.... Graph visualize faceting (by one variable/two variables at a time... choose). Models: -->
<!-- - qp.site ~ recomb -->
<!-- - qp.site ~ recomb + genedensity (are they interacting? (enough to explain the data?)) -->
<!-- - qp.site ~ chr + recomb + genedensity (!declare chr as factor) -->
<!-- - qp.site ~ chr*recomb + genedensity -->

## 1. Import and filter the dataset in R.  

*Read about the metadata: how is the data organized, what do variables in the data mean roughly.  How many chromosomes, how many genomic windows are available in the dataset? Are obvious windows that are “big” outliers?*

*Choose a subset of the dataset by excluding windows that have very few SNPs (LdH_SNPs) and/or a window size that is very small (examine the distribution of ldH_win_size).*

```{r}
data <- read.delim("Data_Mt_DSBionf.csv", sep = ",")
data$chr <- as.factor(data$chr)
plot_data <- data %>% ggplot()
plot_data + geom_histogram(mapping = aes(x = LdH_SNPs, ..density..), bins = 50) + 
    labs(title = "Number of SNPs per window distribution", x = "SNP count", y = "Density")
plot_data + geom_histogram(mapping = aes(x = ldH_win_size, ..density..), bins = 100) +
    labs(title = "Window size distribution", x = "Window size (bp)", y = "Density")
```

Looking at the distribution we can filter the data to retain the ones within an interval of 3 times the sd from the mean.

```{r}
#Filtering for number of SNPs
lowlim <- mean(data$LdH_SNPs) - 3*sd(data$LdH_SNPs)
highlim <- mean(data$LdH_SNPs) + 3*sd(data$LdH_SNPs)
d <- data %>%
    filter(LdH_SNPs > lowlim) %>%
    filter(LdH_SNPs < highlim)

#Filtering for window size
lowlim <- mean(data$ldH_win_size) - 3*sd(data$ldH_win_size)
highlim <- mean(data$ldH_win_size) + 3*sd(data$ldH_win_size)
d <- data %>%
    filter(ldH_win_size > lowlim) %>%
    filter(ldH_win_size < highlim)
```

*Check what percentage of the windows you keep / discard.*

```{r}
cat("We keep ", round(dim(d)[1] / dim(data)[1] * 100, digits = 2), "% of the data\n", sep = "")
```

*Keep that filtered subset fixed for the remaining analysis.*

---------------------------------------------------------------------------

## 2. Displaying genomic data

*Make a graph that illustrates patterns of variation in recombination (as measured by rho) and polymorphism (as measured by qp.site) along chromosome 5 (see for instance Fig 4 of the paper).*

```{r}
plot_chr5 <- d %>% filter(chr == "5") %>% ggplot()

plot_chr5 +
    geom_area(mapping = aes(y = rho_kb / rho_theta / 1000, x = dist_cent), fill = "royalblue4") +
    geom_area(mapping = aes(y = rho_kb / 1000, x = dist_cent), fill = "red3") +
    geom_vline(xintercept = 0) +
    labs(title = "Chromosome 5", x = "Distance to centromere (bp)", 
         y = expression(paste(theta, "w (blue) and ", rho, " (red)")))

plot_chr5 + 
    geom_line(mapping = aes(y = rho_theta, x = dist_cent)) +
    geom_vline(xintercept = 0, color = "red") +
    geom_hline(yintercept = 1, linetype = "dashed") +
    labs(title = "Chromosome 5", x = "Distance to centromere (bp)", 
     y = expression(paste(rho, "/", theta, "w")))

plot_chr5 +
    geom_line(mapping = aes(y = gene_dens, x = dist_cent), color = "forestgreen") +
    geom_vline(xintercept = 0, color = "red") +
    labs(title = "Chromosome 5", x = "Distance to centromere (bp)", 
     y = "Gene Density")
```


## 3. Summarizing levels of Recombination and polymorphism in M. truncatula

*Use a boxplot or any other graphically more convenient way to illustrate the distribution of nucleotide diversity (qp.site) and recombination rate (rho per kb) among the different chromosomes of M. truncatula.*

```{r}
d %>% ggplot(mapping = aes(x = chr, y = qp.site)) +
    geom_violin() +
    geom_boxplot(width=0.1) +
    stat_summary(fun.y=mean, geom="point", size=2, color = "red4") +
    labs(title = "Nucleotide diversity distribution by chromosome", 
         x = "Chromosome", y = "Mean nucleotide diversity per site")

d %>% ggplot(mapping = aes(x = chr, y = rho_kb)) +
    geom_violin() +
    geom_boxplot(width=0.1) +
    stat_summary(fun.y=mean, geom="point", size=2, color = "red4") +
    labs(title = "Recombination rate distribution by chromosome", 
         x = "Chromosome", y = "Recombination rate (ρ) per kb")
```

*Are means or median better summaries for these variables?*

As we can see in the plots, there are higher bound outliers which drag the mean to higher values. Therefore, the median is a better summary for these variables.

*For each chromosome calculate the (mean) (or median) recombination rate and its associated 95% CI. Present these results as a table.*  

We will calculate the Confidence Interval by bootstrapping. We will resample the data n times and calculate the median for each resampling. Then, with the distribution obtained from the bootstrap of medians we will check the 0.025 quantile and the 0.975 quantile to obtain the lower and upper boundary of the CI respectively.

```{r}
#Calculate recombination rate median by chromosome
d_chr <- d %>% group_by(chr) %>% 
    summarise(median_rho = median(rho_kb),
              mean_rho = mean(rho_kb)) #calculate recombination rate by chromosome

N = 100
boot_med <- as.data.frame(matrix(data = 0, nrow = N, ncol = length(levels(d$chr))))
colnames(boot_med) <- levels(d$chr)
for (i in levels(d$chr)) {
    d_chr_i <- d %>% filter(chr == i)
    for (n in 1:N) {
        boot_med[n, i] <- median(sample_n(d_chr_i, dim(d_chr_i)[1], replace = T)$rho_kb)
    }
}

CI <- t(apply(boot_med, 2, function(x) quantile(x, c(0.025, 0.975))))
# means <- apply(boot_med, 2, mean)

cbind(d_chr[,c(2)], CI)     #, d_chr[,c(3)], boot_mean = means)
```


*The authors state that:*

>“The population-scaled recombination rate is approximately one-third of the mutation rate, consistent with expectations for a species with a high selfing rate.” 

*Using the ratio calculated by the authors (rho_theta) discuss if you support that assertion.*

We can see in the $\rho/\theta$ distribution graph for the chromosome 5 (figure 4, reproduced above) that this is not met consistenly along the chromosome 5. We could plot a distribution of the rho_theta ratio:

```{r}
d %>%
    ggplot() +
    geom_histogram(aes(x = rho_theta, ..density..), bins = 100)

d %>%
    ggplot() +
    facet_wrap(~chr) +
    geom_histogram(aes(x = rho_theta, ..density..), bins = 50)
```

The distribution for all chromosomes and individual chromosomes seem to follow a chi squared distribution:  

```{r}

```


*Is there a lot of variation between chromosomes for this ratio?*

## 4. A test of an evolutionary hypothesis

*One of the conclusion of the paper made by the author is that:*  

>“Nucleotide diversity in 100-kb windows was negatively correlated with gene density, which is expected if diversity is shaped by selection acting against slightly deleterious mutations.“ 

*We want to reproduce analysis and discuss if our analysis support this conclusion?*   

*The so called “background selection hypothesis” states that genomic regions that are experiencing more deleterious mutations may exhibit overall less polymorphism because selection as it “weeds out” delterious mutations also eliminates other SNP variation in their vicinity. This hypothesis makes the prediction that “everything else being equal”:*  

- *Gene-dense regions (because they are more prone to produce deleterious mutation) should be exhibiting comparatively less polymorphism than regions that are gene poor.*
- *Background selection will have more influence in regions that have a low recombination rate.*  

*So far testing this hypothesis and its predictions was not easy (except for a few model species) because it requires enormous amounts of polymorphism data. We want to test that hypothesis in M truncatula.*  

**4.1** *Formulate expectations for what genomic covariate will explain variation in nucleotide diversity (qp.site) of a window.*  

*Using linear models, explore if there is support for the predictions of the background selection hypothesis in the patterns of M truncatula genetic diversity.*

**4.2** *Are all chromosome of the M truncatula genome exhibiting similar patterns?*

*(Explore this visually and using appropriate linear models that include a chromosome factor and how chromosome can “interact” with the factors of your anlaysis)*  

*Can other covariate potentially confounding the background selection hypothesis predictions?*

## 5. Tracking footprints of recent and intense selection in the Medicago truncatula genome.

**5.1** *According to the so-called “selective sweep” scenario, if a region contains a mutation that was recently selected, this recent and intense selection is likely to wipe out most of the polymorphism in that region.*

*Do you find footprints for a recent major selective sweep as evidenced by 2 or more consecutive windows with very low diversity (qp.site) relative to the rest of the genome?*

*Hint: explore graphically where the least polymorphic windows (use the 5% least polymorphic windows within the genome) are located. 5.2 Is the location of least polymorphic windows randomly distributed on chromosomes?*

*Hint: To make such a test, you can group windows into larger segments comprising 20 windows and count the number of windows containing least polymorphic windows in each segment. “On average” you expect 1 of such 5% least polymorphic windows per segment. Think about what probability distribution you expect can capture the fact that windows with low level of polymorphisms are occurring “at random” along the chromosome in each segment. Then decide on a statistic you can use to test the null hypothesis that the “location of least polymorphic windows is randomly distributed along the chromosomes”. Get a null distribution for such test statistic and state whether you reject the null or not for each chromosome by discussing the p-values you obtain.*

**5.3** *Another typical footprint of a selective sweep is, besides having lower polymorphism, the fact that genomic regions that have experienced a recent selective sweep are expected to have an excess of rare variants (i.e. the only mutations that contribute to polymorphism are recent and therefore still in low frequency). The excess of rare variants in a window can be measured through the summary statistics “Tajima’s D”. Negative Tajima’s D values mean an excess of rare variants (SNPs) while positive Tajima’s D means an excess of frequent SNPs relative to a neutrally evolving region.*

*Are windows exhibiting abnormally low amounts of polymorphism –as measured by qp.site are also having more negative Tajima’s D values?*

*Use some statistical inference method to examine the relationship. Could other confounding variable obscure this relationship?*
